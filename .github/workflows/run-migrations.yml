name: Run Migrations

on:
  pull_request:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  run-migrations:
    if: contains(github.event.label.name, 'nx-migration-required') || contains(github.event.label.name, 'onecx-migration-required')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Extract all changed packages
        id: extract-packages
        run: |
          set -e
          
          # Ensure we have the base branch
          git fetch origin ${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}
          
          # Get the merge base
          merge_base=$(git merge-base HEAD origin/${{ github.event.pull_request.base.ref }})
          
          # Find all changed package.json files
          changed_files=$(git diff --name-only $merge_base...HEAD | grep package.json || true)
          
          echo "Changed package.json files: $changed_files"
          
          # Extract ALL package updates by comparing JSON
          all_migrations=""
          if [[ -n "$changed_files" ]]; then
            for file in $changed_files; do
              if [[ -f "$file" ]]; then
                echo "Processing $file"
                
                # Get old and new package.json content
                old_content=$(git show $merge_base:$file 2>/dev/null || echo '{}')
                new_content=$(cat "$file")
                
                # Extract all changed packages using Node.js
                migrations=$(node -e "
                  const oldPkg = JSON.parse(\`$old_content\`);
                  const newPkg = JSON.parse(\`$new_content\`);
                  
                  const oldDeps = { ...oldPkg.dependencies, ...oldPkg.devDependencies };
                  const newDeps = { ...newPkg.dependencies, ...newPkg.devDependencies };
                  
                  const migrations = [];
                  
                  // Check for ALL package updates with --from parameter
                  for (const [pkg, newVersion] of Object.entries(newDeps)) {
                    if (oldDeps[pkg] && oldDeps[pkg] !== newVersion) {
                      migrations.push(\`\${pkg}@\${newVersion} --from=\${pkg}@\${oldDeps[pkg]}\`);
                      console.error(\`Found update: \${pkg} from \${oldDeps[pkg]} to \${newVersion}\`);
                    }
                  }
                  
                  console.log(migrations.join('|'));
                ")
                
                if [[ -n "$migrations" ]]; then
                  if [[ -n "$all_migrations" ]]; then
                    all_migrations="$all_migrations|$migrations"
                  else
                    all_migrations="$migrations"
                  fi
                fi
              fi
            done
          fi
          
          echo "all_migrations=$all_migrations" >> $GITHUB_OUTPUT
          echo "Final migrations to run: '$all_migrations'"

      - name: Install dependencies
        run: npm ci

      - name: Run migrations for all changed packages
        if: steps.extract-packages.outputs.all_migrations != ''
        run: |
          set -e
          
          echo "=========================================="
          echo "🚀 STARTING PACKAGE MIGRATIONS"
          echo "=========================================="
          echo "Migrations to run: ${{ steps.extract-packages.outputs.all_migrations }}"
          echo "=========================================="
          
          # Split migrations by | and run each one
          IFS='|' read -ra MIGRATIONS <<< "${{ steps.extract-packages.outputs.all_migrations }}"
          
          migration_count=0
          for migration in "${MIGRATIONS[@]}"; do
            if [[ -n "$migration" && "$migration" != " " ]]; then
              migration_count=$((migration_count + 1))
              
              echo ""
              echo "┌─────────────────────────────────────────┐"
              echo "│ Migration #$migration_count"
              echo "│ Running: nx migrate $migration"
              echo "└─────────────────────────────────────────┘"
              
              npx nx migrate $migration || echo "❌ No migrations for '$migration' or migration failed"
              
              echo "✅ Migration #$migration_count completed"
              echo "─────────────────────────────────────────"
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "📦 INSTALLING MIGRATION DEPENDENCIES"
          echo "=========================================="
          
          # Install any new dependencies from migrations
          if [[ -f "package.json" ]]; then
            npm install
          fi
          
          echo ""
          echo "=========================================="
          echo "🔧 RUNNING MIGRATION SCRIPTS"
          echo "=========================================="
          
          # Run the actual migrations
          if [[ -f "migrations.json" ]]; then
            echo "Found migrations.json - executing migration scripts..."
            npx nx migrate --run-migrations || echo "❌ No migrations to run"
            echo "✅ Migration scripts completed"
          else
            echo "ℹ️ No migrations.json found - no migration scripts to run"
          fi
          
          echo ""
          echo "=========================================="
          echo "🎉 ALL MIGRATIONS COMPLETED"
          echo "=========================================="

      - name: Commit all migration changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Pull any changes from remote first
          git pull origin ${{ github.event.pull_request.head.ref }} || echo "No remote changes to pull"
          
          if [[ -n "$(git status --porcelain)" ]]; then
            echo ""
            echo "=========================================="
            echo "📝 COMMITTING ALL MIGRATION CHANGES"
            echo "=========================================="
            
            git add .
            git commit --no-verify -m "refactor: run package migrations

            Auto-generated by GitHub Actions after dependency updates.
            Includes migrations.json for team coordination and reproducible builds."
            
            # Push to the PR branch
            git push origin HEAD:${{ github.event.pull_request.head.ref }}
            
            echo "✅ All migration changes committed and pushed"
            echo "=========================================="
          else
            echo ""
            echo "=========================================="
            echo "ℹ️ NO CHANGES TO COMMIT"
            echo "=========================================="
          fi
          
          # Determine which label to remove based on the event
          if [[ "${{ contains(github.event.label.name, 'nx-migration-required') }}" == "true" ]]; then
            gh pr edit ${{ github.event.pull_request.number }} --remove-label "nx-migration-required"
          fi
          if [[ "${{ contains(github.event.label.name, 'onecx-migration-required') }}" == "true" ]]; then
            gh pr edit ${{ github.event.pull_request.number }} --remove-label "onecx-migration-required"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
