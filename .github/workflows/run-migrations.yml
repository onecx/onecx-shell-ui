name: Run Migrations

on:
  pull_request:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  run-nx-migration:
    if: contains(github.event.label.name, 'nx-migration-required')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Extract package versions from PR
        id: extract-versions
        run: |
          # Get the changed package.json files from the PR
          git fetch origin ${{ github.event.pull_request.base.ref }}
          
          # Find all changed package.json files
          changed_files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep package.json)
          
          echo "Changed package.json files:"
          echo "$changed_files"
          
          # Extract NX package updates
          nx_packages=""
          for file in $changed_files; do
            if [[ -f "$file" ]]; then
              # Look for @nx/ packages in the diff
              nx_updates=$(git diff origin/${{ github.event.pull_request.base.ref }}...HEAD "$file" | grep -E '^\+.*"@nx/|^\+.*"nx"' | sed 's/^+[[:space:]]*//' | sed 's/[",]//g' | awk '{print $1 "@" $2}' || true)
              if [[ -n "$nx_updates" ]]; then
                nx_packages="$nx_packages $nx_updates"
              fi
            fi
          done
          
          echo "nx_packages=$nx_packages" >> $GITHUB_OUTPUT
          echo "NX packages to migrate: $nx_packages"

      - name: Install dependencies
        run: npm ci

      - name: Run NX migrations
        if: steps.extract-versions.outputs.nx_packages != ''
        run: |
          set -e
          
          # Run migrations for each NX package
          for pkg in ${{ steps.extract-versions.outputs.nx_packages }}; do
            if [[ -n "$pkg" && "$pkg" != " " ]]; then
              echo "Running migration for: $pkg"
              npx nx migrate "$pkg" || echo "Migration for $pkg failed or not needed"
            fi
          done
          
          # Install any new dependencies from migrations
          npm install
          
          # Run the actual migrations
          if [[ -f "migrations.json" ]]; then
            npx nx migrate --run-migrations || echo "No migrations to run"
            rm -f migrations.json
          fi

      - name: Commit migration changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [[ -n "$(git status --porcelain)" ]]; then
            git add .
            git commit -m "chore: run NX migrations

            Auto-generated by GitHub Actions after dependency updates."
            git push
            
            # Remove the label since migration is complete
            gh pr edit ${{ github.event.pull_request.number }} --remove-label "nx-migration-required"
          else
            echo "No changes to commit"
            # Still remove the label
            gh pr edit ${{ github.event.pull_request.number }} --remove-label "nx-migration-required"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  run-onecx-migration:
    if: contains(github.event.label.name, 'onecx-migration-required')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Extract OneCX package versions from PR
        id: extract-onecx-versions
        run: |
          # Get the changed package.json files from the PR
          git fetch origin ${{ github.event.pull_request.base.ref }}
          
          # Find all changed package.json files
          changed_files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | grep package.json)
          
          echo "Changed package.json files:"
          echo "$changed_files"
          
          # Extract OneCX package updates
          onecx_packages=""
          for file in $changed_files; do
            if [[ -f "$file" ]]; then
              # Look for @onecx/ packages in the diff
              onecx_updates=$(git diff origin/${{ github.event.pull_request.base.ref }}...HEAD "$file" | grep -E '^\+.*"@onecx/' | sed 's/^+[[:space:]]*//' | sed 's/[",]//g' | awk '{print $1 "@" $2}' || true)
              if [[ -n "$onecx_updates" ]]; then
                onecx_packages="$onecx_packages $onecx_updates"
              fi
            fi
          done
          
          echo "onecx_packages=$onecx_packages" >> $GITHUB_OUTPUT
          echo "OneCX packages to migrate: $onecx_packages"

      - name: Install dependencies
        run: npm ci

      - name: Run OneCX migrations
        if: steps.extract-onecx-versions.outputs.onecx_packages != ''
        run: |
          set -e
          
          # Run migrations for each OneCX package
          for pkg in ${{ steps.extract-onecx-versions.outputs.onecx_packages }}; do
            if [[ -n "$pkg" && "$pkg" != " " ]]; then
              echo "Running migration for: $pkg"
              npx nx migrate "$pkg" || echo "Migration for $pkg failed or not needed"
            fi
          done
          
          # Install any new dependencies from migrations
          export NX_MIGRATE_SKIP_INSTALL=true
          npm install
          
          # Run the actual migrations if they exist
          if [[ -f "migrations.json" ]]; then
            npx nx migrate --run-migrations --if-exists || echo "No migrations to run"
            rm -f migrations.json
          fi

      - name: Commit migration changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if [[ -n "$(git status --porcelain)" ]]; then
            git add .
            git commit -m "chore: run OneCX migrations

            Auto-generated by GitHub Actions after dependency updates."
            git push
            
            # Remove the label since migration is complete
            gh pr edit ${{ github.event.pull_request.number }} --remove-label "onecx-migration-required"
          else
            echo "No changes to commit"
            # Still remove the label
            gh pr edit ${{ github.event.pull_request.number }} --remove-label "onecx-migration-required"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}